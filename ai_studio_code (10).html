<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro Collector (Custom Image Edition)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=ZCOOL+QingKe+HuangYou&family=Roboto:wght@400;700&display=swap');

        :root {
            --bg-color: #fdf6e3;
            --case-color: #ece8d9;
            --key-orange: #ff9f43;
            --key-dark: #e67e22;
            --key-text: #3e2723;
            --screen-bg: #1c1c1c;
            --screen-text: #4aff4a;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-drag: none; touch-action: none; }

        body {
            margin: 0; height: 100vh; overflow: hidden;
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, #fdf6e3 0%, #f0e6cc 100%);
            display: flex; justify-content: center; align-items: flex-end; perspective: 1000px;
        }

        /* === 顶部卡槽栏 === */
        .deck-container {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%); z-index: 4000;
            display: flex; flex-direction: column; align-items: center; gap: 0;
        }
        .deck-bar {
            background-color: var(--case-color); padding: 15px 25px 25px 25px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2), inset 0 -5px 10px rgba(0,0,0,0.05);
            display: flex; gap: 12px; border: 1px solid #dcd8c0; border-top: none; position: relative;
        }
        .deck-slot {
            width: 60px; height: 85px; background-color: #b8b4a6; border-radius: 6px;
            box-shadow: inset 3px 3px 6px rgba(0,0,0,0.3), 1px 1px 0 white; border: 2px solid #959185; position: relative;
        }
        .deck-slot::after { content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 2px; background: rgba(0,0,0,0.1); }
        .deck-slot::before { content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2px; height: 20px; background: rgba(0,0,0,0.1); }

        .confirm-btn {
            position: relative; margin-top: -15px; padding: 10px 35px;
            background-color: var(--key-orange); color: var(--key-text);
            border: none; border-radius: 12px; font-family: 'ZCOOL QingKe HuangYou', sans-serif;
            font-size: 18px; letter-spacing: 1px; cursor: pointer; pointer-events: auto; transition: all 0.05s;
            box-shadow: 0 6px 0 var(--key-dark), 0 10px 10px rgba(0,0,0,0.2), inset 2px 2px 5px rgba(255,255,255,0.4);
            z-index: 4002;
        }
        .confirm-btn:active { transform: translateY(6px); box-shadow: 0 0 0 var(--key-dark), inset 0 3px 5px rgba(0,0,0,0.3); }
        .confirm-btn:hover { filter: brightness(1.05); }

        /* === 隐藏导出区 === */
        #export-stage {
            position: absolute; top: -9999px; left: -9999px; width: 800px;
            background: #f0f0f0; padding: 40px;
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); gap: 30px;
            justify-items: center; align-items: center;
        }
        .export-card {
            width: 220px; height: 310px; background: white; border-radius: 10px;
            overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .export-card img { width: 100%; height: 100%; object-fit: cover; }

        /* === 卡牌样式 (纯净版) === */
        .card-container {
            position: absolute; width: 220px; height: 310px; 
            background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            transform-origin: center center; cursor: grab;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), top 0.4s, left 0.4s, box-shadow 0.2s;
            z-index: 10;
        }
        
        .card-container img {
            width: 100%; height: 100%; object-fit: cover; pointer-events: none; display: block;
        }

        .card-container.in-slot { box-shadow: none; cursor: grab; z-index: 4001 !important; }
        .card-container:active { cursor: grabbing; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 5000 !important; }
        .card-container.no-transition { transition: none !important; }

        /* === 3D 电脑 === */
        .computer-wrapper {
            position: relative; width: 680px; height: auto; z-index: 2000; margin-bottom: 20px;
            display: flex; flex-direction: column; align-items: center; transform-style: preserve-3d;
        }
        .monitor-unit {
            width: 90%; height: 160px; background: var(--case-color); border-radius: 20px 20px 0 0;
            box-shadow: inset 5px 5px 10px rgba(255,255,255,0.8), inset -5px -5px 10px rgba(0,0,0,0.1), 0 10px 20px rgba(0,0,0,0.3);
            display: flex; align-items: center; padding: 15px; gap: 15px; position: relative; z-index: 2;
        }
        .screen-bezel {
            flex: 1; height: 100%; background: #dcd8c0; border: 4px solid #bfb690; border-radius: 10px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; padding: 10px;
        }
        .crt {
            width: 100%; height: 100%; background: var(--screen-bg); border-radius: 50px / 30px;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8); color: var(--screen-text); font-family: 'VT323', monospace;
            font-size: 22px; display: flex; align-items: center; justify-content: center; text-shadow: 0 0 5px var(--screen-text);
            position: relative; overflow: hidden; text-transform: uppercase;
        }
        .crt::after { content: ""; position: absolute; inset: 0; background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.2) 50%); background-size: 100% 4px; pointer-events: none; }
        .drive-panel { width: 140px; height: 100%; display: flex; flex-direction: column; gap: 10px; padding-top: 10px; }
        .floppy { background: #333; height: 40px; border-radius: 4px; border-bottom: 2px solid #555; position: relative; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; }
        .floppy-slot { width: 70%; height: 4px; background: #000; position: absolute; left: 10px; }
        .floppy-btn { width: 15px; height: 10px; background: var(--key-orange); cursor: pointer; }
        .power-switch { margin-top: auto; width: 40px; height: 40px; border-radius: 50%; background: #ddd; border: 3px solid #bbb; box-shadow: 3px 3px 5px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; cursor: pointer; font-weight: bold; color: #555; font-size: 10px; }
        
        .keyboard-chassis {
            width: 100%; background: var(--case-color); transform: perspective(800px) rotateX(15deg); transform-origin: top center;
            border-radius: 5px 5px 20px 20px; padding: 20px; box-shadow: 0 20px 30px rgba(0,0,0,0.4), 0 5px 0 #cbbfa0;
            margin-top: -10px; border-top: 1px solid rgba(255,255,255,0.5); z-index: 3;
        }
        .key-bed { background: #d5cfb8; border-radius: 10px; padding: 10px; box-shadow: inset 3px 3px 8px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 6px; }
        .key-row { display: flex; justify-content: space-between; gap: 6px; }
        .key {
            position: relative; height: 40px; background: var(--key-orange); border-radius: 4px;
            box-shadow: 0 4px 0 var(--key-dark), 0 5px 5px rgba(0,0,0,0.2); color: var(--key-text); font-weight: bold; font-size: 12px;
            display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.05s, box-shadow 0.05s;
            flex: 1; backface-visibility: hidden;
        }
        .key.func { background: #b0bec5; color: #333; box-shadow: 0 4px 0 #78909c, 0 5px 5px rgba(0,0,0,0.2); font-size: 10px; }
        .key.enter { background: #e67e22; color: white; box-shadow: 0 4px 0 #d35400, 0 5px 5px rgba(0,0,0,0.2); flex: 1.8; }
        .key.space { flex: 5; background: var(--key-orange); }
        .key:active, .key.pressed { transform: translateY(4px); box-shadow: 0 0 0 var(--key-dark), inset 0 2px 3px rgba(0,0,0,0.2); }
        
        #real-input { position: absolute; opacity: 0; top: -1000px; }
        #spawn-slot { position: absolute; top: 150px; left: 50%; transform: translateX(-50%); width: 300px; height: 10px; z-index: -1; }

        @media (max-width: 700px) {
            .computer-wrapper { width: 95%; transform: scale(0.7); transform-origin: bottom center; margin-bottom: -40px; }
            .key { height: 35px; font-size: 10px; }
            .deck-container { transform: translateX(-50%) scale(0.8); transform-origin: top center; }
        }
    </style>
</head>
<body>

    <div id="export-stage"></div>

    <div class="deck-container">
        <div class="deck-bar">
            <div class="deck-slot" data-index="0"></div>
            <div class="deck-slot" data-index="1"></div>
            <div class="deck-slot" data-index="2"></div>
            <div class="deck-slot" data-index="3"></div>
            <div class="deck-slot" data-index="4"></div>
            <div class="deck-slot" data-index="5"></div>
        </div>
        <button class="confirm-btn" id="export-btn">确定并生成 (3x2)</button>
    </div>

    <div class="computer-wrapper" onclick="document.getElementById('real-input').focus()">
        <div class="monitor-unit">
            <div class="screen-bezel">
                <div class="crt"><span id="screen-display">系统就绪 请输入...</span></div>
            </div>
            <div class="drive-panel">
                <div class="floppy"><div class="floppy-slot"></div><div class="floppy-btn" id="eject-btn"></div></div>
                <div class="power-switch" onclick="location.reload()">重置</div>
            </div>
        </div>
        <input type="text" id="real-input" autocomplete="off">
        <div id="spawn-slot"></div>
        <div class="keyboard-chassis">
            <div class="key-bed">
                <div class="key-row">
                    <div class="key" data-key="1">1</div><div class="key" data-key="2">2</div><div class="key" data-key="3">3</div><div class="key" data-key="4">4</div><div class="key" data-key="5">5</div><div class="key" data-key="6">6</div><div class="key" data-key="7">7</div><div class="key" data-key="8">8</div><div class="key" data-key="9">9</div><div class="key" data-key="0">0</div><div class="key func" style="flex:1.5" data-key="Backspace">删</div>
                </div>
                <div class="key-row">
                    <div class="key" data-key="q">Q</div><div class="key" data-key="w">W</div><div class="key" data-key="e">E</div><div class="key" data-key="r">R</div><div class="key" data-key="t">T</div><div class="key" data-key="y">Y</div><div class="key" data-key="u">U</div><div class="key" data-key="i">I</div><div class="key" data-key="o">O</div><div class="key" data-key="p">P</div>
                </div>
                <div class="key-row">
                    <div class="key" style="flex:0.5"></div><div class="key" data-key="a">A</div><div class="key" data-key="s">S</div><div class="key" data-key="d">D</div><div class="key" data-key="f">F</div><div class="key" data-key="g">G</div><div class="key" data-key="h">H</div><div class="key" data-key="j">J</div><div class="key" data-key="k">K</div><div class="key" data-key="l">L</div><div class="key enter" data-key="Enter">确认</div>
                </div>
                <div class="key-row">
                    <div class="key" style="flex:1"></div><div class="key" data-key="z">Z</div><div class="key" data-key="x">X</div><div class="key" data-key="c">C</div><div class="key" data-key="v">V</div><div class="key" data-key="b">B</div><div class="key" data-key="n">N</div><div class="key" data-key="m">M</div><div class="key" style="flex:1"></div>
                </div>
                <div class="key-row"><div class="key space" data-key=" ">SPACE</div></div>
            </div>
        </div>
    </div>

    <script>
        // === 自定义图片映射 (新增皮卡丘和鲤鱼王) ===
        const customImages = {
            "umbreon": "https://i.imgur.com/SaBap0D.jpeg",
            "pikachu": "https://i.imgur.com/5IqB096.jpeg",
            "magikarp": "https://i.imgur.com/JrMGOln.jpeg"
        };

        // === 中文映射表 ===
        const cnMap = {
            "妙蛙种子": "bulbasaur", "小火龙": "charmander", "喷火龙": "charizard",
            "杰尼龟": "squirtle", "皮卡丘": "pikachu", "雷丘": "raichu",
            "超梦": "mewtwo", "梦幻": "mew", "耿鬼": "gengar", "伊布": "eevee", 
            "鲤鱼王": "magikarp", "暴鲤龙": "gyarados",
            "月亮伊布": "umbreon", "月亮精灵": "umbreon"
            // ... 其他 151 只宝可梦依然可以通过英文ID搜索
        };
        
        const typeColors = { normal: '#A8A77A', fire: '#EE8130', water: '#6390F0', electric: '#F7D02C', grass: '#7AC74C', ice: '#96D9D6', fighting: '#C22E28', poison: '#A33EA1', ground: '#E2BF65', flying: '#A98FF3', psychic: '#F95587', bug: '#A6B91A', rock: '#B6A136', ghost: '#735797', dragon: '#6F35FC', dark: '#705746', steel: '#B7B7CE', fairy: '#D685AD' };

        const realInput = document.getElementById('real-input');
        const screenDisplay = document.getElementById('screen-display');
        const visualKeys = document.querySelectorAll('.key');
        const deckSlots = document.querySelectorAll('.deck-slot');
        const exportBtn = document.getElementById('export-btn');
        let isProcessing = false;

        document.body.addEventListener('click', (e) => { if(!e.target.closest('button')) realInput.focus(); });
        realInput.addEventListener('input', () => screenDisplay.textContent = (realInput.value || "").toUpperCase() + "_");
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') startGeneration();
            const btn = Array.from(visualKeys).find(k => k.dataset.key.toLowerCase() === e.key.toLowerCase());
            if(btn) btn.classList.add('pressed');
        });
        document.addEventListener('keyup', () => visualKeys.forEach(k => k.classList.remove('pressed')));
        visualKeys.forEach(btn => {
            btn.addEventListener('mousedown', (e) => { e.stopPropagation(); btn.classList.add('pressed'); const val = btn.dataset.key; if(val==='Enter') startGeneration(); else if(val==='Backspace') realInput.value=realInput.value.slice(0,-1); else if(val===' ') realInput.value+=' '; else if(val.length===1) realInput.value+=val; screenDisplay.textContent=realInput.value.toUpperCase()+"_"; });
            btn.addEventListener('mouseup', () => btn.classList.remove('pressed'));
        });

        async function startGeneration() {
            let query = realInput.value.trim();
            if (!query || isProcessing) return;
            if (cnMap[query]) query = cnMap[query];
            isProcessing = true;
            screenDisplay.textContent = "正在搜索...";
            try {
                const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${query.toLowerCase()}`);
                if (!response.ok) throw new Error('Not found');
                const data = await response.json();
                screenDisplay.textContent = "打印中...";
                spawnCard(data);
                realInput.value = "";
            } catch (error) {
                screenDisplay.textContent = "错误: 未找到";
                isProcessing = false;
            }
        }

        function spawnCard(data) {
            const card = document.createElement('div');
            card.className = 'card-container';
            
            // === 图片逻辑 ===
            let imgUrl = data.sprites.other['official-artwork'].front_default || data.sprites.front_default;
            // 检查是否有自定义图片
            if (customImages[data.name]) {
                imgUrl = customImages[data.name];
            }

            card.dataset.imgUrl = imgUrl; // 导出用
            
            // 纯净卡牌 HTML
            card.innerHTML = `<img src="${imgUrl}" crossorigin="anonymous">`;

            // 兜底背景色
            const color = typeColors[data.types[0].type.name] || '#eee';
            card.style.backgroundColor = color;

            document.body.appendChild(card);
            
            const slotRect = document.getElementById('spawn-slot').getBoundingClientRect();
            const cardRect = card.getBoundingClientRect();
            const startX = slotRect.left + (slotRect.width/2) - (cardRect.width/2);
            const startY = slotRect.top;
            card.classList.add('no-transition');
            card.style.left = `${startX}px`; card.style.top = `${startY}px`;
            card.style.transform = `scale(0.8)`;
            void card.offsetWidth;
            card.classList.remove('no-transition');
            
            setTimeout(() => {
                const endY = startY - 250 - Math.random()*50;
                const endX = startX + (Math.random()*200 - 100);
                card.style.left = `${endX}px`; card.style.top = `${endY}px`;
                card.style.transform = `scale(1) rotate(${(Math.random()*20)-10}deg)`;
                setTimeout(() => { isProcessing = false; screenDisplay.textContent = "系统就绪"; makeDraggable(card); }, 500);
            }, 50);
        }

        function makeDraggable(el) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;
            const onStart = (cx, cy) => {
                isDragging = true; el.style.zIndex = 5000; el.classList.add('no-transition');
                if(el.classList.contains('in-slot')) el.style.transform = `scale(1)`;
                startX = cx; startY = cy;
                const style = window.getComputedStyle(el);
                initialLeft = parseFloat(style.left); initialTop = parseFloat(style.top);
            };
            const onMove = (cx, cy) => {
                if(!isDragging) return;
                el.style.left = `${initialLeft + (cx - startX)}px`; el.style.top = `${initialTop + (cy - startY)}px`;
            };
            const onEnd = () => {
                if(isDragging) { isDragging = false; el.classList.remove('no-transition'); checkSlot(el); }
            };
            el.addEventListener('mousedown', e=>onStart(e.clientX, e.clientY));
            window.addEventListener('mousemove', e=>onMove(e.clientX, e.clientY));
            window.addEventListener('mouseup', onEnd);
            el.addEventListener('touchstart', e=>onStart(e.touches[0].clientX, e.touches[0].clientY), {passive:false});
            window.addEventListener('touchmove', e=>{if(isDragging){e.preventDefault();onMove(e.touches[0].clientX,e.touches[0].clientY)}}, {passive:false});
            window.addEventListener('touchend', onEnd);
        }

        function checkSlot(card) {
            const cardRect = card.getBoundingClientRect();
            const cx = cardRect.left + cardRect.width/2;
            const cy = cardRect.top + cardRect.height/2;
            let matched = false;
            deckSlots.forEach(slot => {
                const sr = slot.getBoundingClientRect();
                if(cx > sr.left && cx < sr.right && cy > sr.top && cy < sr.bottom) {
                    const tx = sr.left + (sr.width/2) - (220/2);
                    const ty = sr.top + (sr.height/2) - (310/2);
                    card.style.left = `${tx}px`; card.style.top = `${ty}px`;
                    card.style.transform = `scale(0.27)`;
                    card.classList.add('in-slot');
                    deckSlots.forEach(s => { if(s !== slot && s.dataset.element === card) delete s.dataset.element; });
                    slot.dataset.element = card; matched = true;
                }
            });
            if(!matched && card.classList.contains('in-slot')) {
                card.classList.remove('in-slot'); card.style.transform = `scale(1) rotate(${(Math.random()*20)-10}deg)`;
                card.style.zIndex = 100; deckSlots.forEach(s => { if(s.dataset.element === card) delete s.dataset.element; });
            }
        }

        exportBtn.addEventListener('click', () => {
            const stage = document.getElementById('export-stage');
            stage.innerHTML = '';
            const cardsInSlots = [];
            deckSlots.forEach(slot => {
                const sr = slot.getBoundingClientRect();
                const scx = sr.left + sr.width/2;
                const scy = sr.top + sr.height/2;
                const card = Array.from(document.querySelectorAll('.card-container.in-slot')).find(c => {
                    const cr = c.getBoundingClientRect();
                    const ccx = cr.left + cr.width/2;
                    const ccy = cr.top + cr.height/2;
                    return Math.abs(ccx - scx) < 10 && Math.abs(ccy - scy) < 10;
                });
                if(card) cardsInSlots.push(card.dataset.imgUrl);
                else cardsInSlots.push(null);
            });

            if(cardsInSlots.every(c => c === null)) { alert("卡槽是空的！"); return; }
            
            cardsInSlots.forEach(imgUrl => {
                if(imgUrl) {
                    const div = document.createElement('div'); div.className = 'export-card';
                    div.innerHTML = `<img src="${imgUrl}" crossorigin="anonymous">`;
                    stage.appendChild(div);
                } else {
                    const div = document.createElement('div'); div.style.cssText = "width:220px;height:310px;border:2px dashed #ccc;border-radius:10px;display:flex;justify-content:center;align-items:center;color:#ccc";
                    div.innerHTML = 'EMPTY'; stage.appendChild(div);
                }
            });
            
            exportBtn.textContent = "生成中...";
            html2canvas(stage, { backgroundColor: '#ffffff', scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a'); link.download = 'my-team.png'; link.href = canvas.toDataURL(); link.click();
                exportBtn.textContent = "确定并生成 (3x2)";
            });
        });
    </script>
</body>
</html>